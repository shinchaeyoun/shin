(function() {
  const $quizLinks = document.querySelectorAll('a[href^="#quiz-kit-key-"]');
  const $quizShortcodes = document.querySelectorAll('[data-quiz-kit-key]');

  function loadQuizKitAppScript() {
    const script = document.createElement('script');

    script.async = true;
    script.setAttribute(
        'src',
        'https://d38jc50suw8dg3.cloudfront.net/current/static/bundle.min.js',
    );
    document.head.appendChild(script);
  }

  function loadQuizKitAppStyles() {
    const appStyles = document.createElement('link');

    appStyles.type = 'text/css';
    appStyles.rel = 'stylesheet';
    appStyles.href = 'https://d38jc50suw8dg3.cloudfront.net/current/static/main.min.css';
    appStyles.media = 'all';

    document.head.appendChild(appStyles);
  }

  if (($quizLinks.length || $quizShortcodes.length) && !window.quizKitScriptLoaded) {
    window.quizKitScriptLoaded = true;
    loadQuizKitAppScript();
    loadQuizKitAppStyles();
  }

  const href = window.location.href;

  if (href.indexOf('quiz-kit-api-call-url') !== -1 && href.indexOf('quiz-kit-id') !== -1) {
    const apiCallUrl = href.split('quiz-kit-api-call-url=')[1];
    const quizId = href.split('quiz-kit-id=')[1].split('&')[0];

    if (quizId && apiCallUrl) {
      const $form = document.querySelectorAll('form[action="/cart/add"]')[0];
      const $input = document.createElement("input");

      $input.setAttribute("type", "hidden");
      $input.setAttribute("name", "properties[_quiz_kit_id]");
      $input.setAttribute("value", quizId);

      if ($form) {
        if (quizId !== 'disabled') $form.appendChild($input);

        $form.addEventListener('submit', function() {
          const variantSelector = $form.querySelectorAll('[name="id"]')[0];

          if (variantSelector) {
            const variantId = variantSelector.value;
            const xhr = new XMLHttpRequest();

            xhr.open('POST', apiCallUrl, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({variantId: parseInt(variantId, 10)}));
          }
        });
      }
    }
  }
})();
